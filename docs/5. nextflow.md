# Nextflow

[Nextflow](https://www.nextflow.io/) is a workflow manager that co-ordinates multiple steps in a pipeline. Think of it as SLURM but instead of managing multiple jobs likely submitted by multiple users, Nextflow will manage all steps in your pipeline. So instead of running FastQC and waiting for its results to feed to an aligner, you just run the whole pipeline at once.   

[nf.core](https://nf-co.re/) is an open source database of pipelines you can use to do your analysis. We use the RNA-seq pipeline from nf.core for the analysis in the facility. 

Scripts for running the analysis using the Nextflow pipeline are also available in the [`UPSCb-common`](https://github.com/UPSCb/UPSCb-common/tree/master/nextflow) repository. 

>!!! Caution
> Be sure to modify the `.config` and `.json` files to correctly provide the source files that you want to analyse before running the pipeline.

## Nextflow Installation

Brief instructions on how to install Nextflow:

## Prerequisites:
1. Install java from [OpenJDK](https://jdk.java.net/archive/). Select version 1.18.0.2 (the latest one known to work with NF - 2023-03-13), choose `Linux X64`. Right click and save the link. (Version 24GA works - 2025-06-05). As it seems to be working with more recent Java version, one can also aim for the latest GA version, [24](https://jdk.java.net/24/) on 2025-06-05.
2. use `wget` to download it in your home dir on the server
3. decompress the archive, then delete the archive
4. create a `~/bin` directory if it does not exists in your home dir
5. cd into the `~/bin` directory
6. create a link to all the java executables: `ln -s ../jdk-18.0.2/bin/* .`
7. exit your terminal and start a new one

## Installation
1. Run `curl -s https://get.nextflow.io | bash`
2. `mv nextflow bin` to move the newly created executable to your bin dir
3. give the command `nextflow` a try

## Configuration
To be able to run on system running SLURM, you'll need to set up and use a profile.

### Profiles

In your config file, you will need to set  profile and you will need to have that profile used by nextflow (`-profile` on the command line - see the [doc](https://www.nextflow.io/docs/latest/config.html#config-profiles))

Here is an example profile that will work on UPPMAX, just change the account to run on the UPSC servers. (Commented out some lines to prevent auto-retries)

```nextflow
// Profile
profiles {

    // Uppmax general profile
    uppmax {
        params{
          account        = 'snic2022-5-342'
	        email = 'nicolas.delhomme@umu.se'
	        mailType = 'END,FAIL'
        }
        process {
            executor       = 'slurm'
            clusterOptions = "-A '${params.account}' --mail-type '${params.mailType}' --mail-user '${params.email}'"
//            memory         = { 20.GB * task.attempt }
            cpus           = { 1 * task.attempt }
            time           = { 10.h * task.attempt }ßßß
            scratch        = '$SNIC_TMP'
//            errorStrategy  = 'retry'
//            maxRetries     = 2
        }
    }
}

```

## Running
Make sure to set the `NXF_HOME` to be in the project dir and not your home dir:

As on UPPMAX:

```txt
Note that NXF_HOME is set to $HOME/.nextflow
Please change NXF_HOME to a place in your project directory (export NXF_HOME=yourprojectfolder)
```

Meaning, you should:

`export NXF_HOME=/mnt/ada/projects/pine/nstreet/pine-leaf-fungi/nextflow`
